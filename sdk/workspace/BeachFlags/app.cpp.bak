#include "app.h"
#include "scenario.h"
#include "robot.h"

#include "detectgCheck.h"
#include "detectSonar.h"
#include "detectMotorAngle.h"
#include "detectBrightness.h"
#include "detectCrossing.h"
#include "detectDistance.h"
#include "detectSonarOrDistance.h"
#include "detectGarageColor.h"
#include "detectStart.h"
#include "detectHsv.h"
#include "detectAngle.h"
#include "detectCount.h"
#include "stay.h"
#include "trace.h"
#include "turn.h"
#include "loopFrontAndBack.h"


static void createScenario(Scenario &scenario);
static void createScenario_slalom(Scenario &scenario);
static void createScenario_garage(Scenario &scenario);
static void calibration(int &black, int &white);

// ここを変える！！！
//青エッジ検知
#define BLUE_EDGE_H_MIN		195
#define BLUE_EDGE_H_MAX		225
#define BLUE_EDGE_S_MIN		65
#define BLUE_EDGE_S_MAX		135
#define BLUE_EDGE_V_MIN		106
#define BLUE_EDGE_V_MAX		160
//なんだっけ
#define BLACK_V_MAX			50 // 黒のV +40 元々30
//白黒
#define WHITE_R				157 //183
#define BLACK_R				9
#define WOOD_WHITE_R		167
#define WOOD_BLACK_R		17
//自動速度走行のプラスナイマス
#define SPEED_DELTA_MINUS	8
#define SPEED_DELTA_PLUS	5

//ショートカット(1はあり, 0はなし)
#define SHORT_ON 1

//白(213, 19, 171)
#define WHITE_H_MIN		200
#define WHITE_H_MAX		230
#define WHITE_S_MIN		0
#define WHITE_S_MAX		40
#define WHITE_V_MIN		150
#define WHITE_V_MAX		190

//スラロームのパターン 
#define SLA_NO1 1
#define SLA_NO2 2

//ガレージの色判定
#define GARAGE_RED			0
#define GARAGE_GREEN		1
#define GARAGE_YELLOW		2
#define GARAGE_BLUE			3
//ガレージ 青色
#define BLUE_H_MIN		195
#define BLUE_H_MAX		225
#define BLUE_S_MIN		180
#define BLUE_S_MAX		220
#define BLUE_V_MIN		60
#define BLUE_V_MAX		80
//ガレージ 黄色
#define YELLOW_H_MIN	30
#define YELLOW_H_MAX	50
#define YELLOW_S_MIN	100
#define YELLOW_S_MAX	130
#define YELLOW_V_MIN	150
#define YELLOW_V_MAX	180
//ガレージ 赤色
#define RED_H_MIN		347
#define RED_H_MAX		367
#define RED_S_MIN		0
#define RED_S_MAX		255
#define RED_V_MIN		0
#define RED_V_MAX		255
//ガレージ 緑色
#define GREEN_H_MIN		140
#define GREEN_H_MAX		160
#define GREEN_S_MIN		0
#define GREEN_S_MAX		255
#define GREEN_V_MIN		0
#define GREEN_V_MAX		255



// メインタスク
void mainTask(intptr_t unused)
{
	act_tsk(SCENARIO_TASK);
	sta_cyc(SCENARIO_CYCL);
	slp_tsk();
	//...
	ext_tsk();
}

// シナリオタスク
void scenarioTask(intptr_t unused)
{
	//calibration(gBlack, gWhite);
	gBlack = BLACK_R;
	gWhite = WHITE_R;
	gSlaNo = SLA_NO2;
	gGarageColor = GARAGE_GREEN;


	//シナリオを作成する
	bool complete = false;
	// Scenario* pScenario = new Scenario();	
	// createScenario(*pScenario);
	// do {
	// 	//スタートからゴールまでのシナリオを実行する
	// 	complete = pScenario->excute();
	// 	slp_tsk();
	// } while (!complete);
	// delete pScenario;

 	 Scenario* pScenario_slalom = new Scenario();
	 createScenario_slalom(*pScenario_slalom);
	 complete = false;
	 do {
	 	// スラロームのシナリオを実行する
	 	complete = pScenario_slalom->excute();
	 	slp_tsk();
	 } while (!complete);
	 delete pScenario_slalom;

  	//  Scenario* pScenario_garage = new Scenario();
	//  createScenario_garage(*pScenario_garage);
	//  complete = false;
	//  do {
	//  	// ガレージのシナリオを実行する
	//  	complete = pScenario_garage->excute();
	//  	slp_tsk();
	//  } while (!complete);
	//  delete pScenario_garage;

	// 止まる
	gRobot.leftMotor()->setPWM(0);
	gRobot.rightMotor()->setPWM(0);

	wup_tsk(MAIN_TASK);
	ext_tsk();
}

// シナリオを作成する.
static void createScenario(Scenario &scenario)
{
	const int   darkThreshold = gBlack + 20;
	const int   grayThreshold = (gWhite + gBlack) / 2 - 10;
	double      Kp,                 Kd;
	int    	    speedMin,           speedMax;
	int         steeringMin,        steeringMax;
	int         brihgtnessMin,      brightnessMax;
	int         fixedTurningAmount;
	int         minH, maxH, minS, maxS, minV, maxV;
	double      threTravelDistance;
	LeftOrRight lineEdge;

	// #0 スタート
	// 検知：スタート操作検知
	// 走行：停止
	scenario.append({
		new DetectStart(),
		new Stay() });

	// #1
	// 検知：スタートから1.2m進んだ（小円に入ってすぐの場所）
	// 走行：右ライントレース
	scenario.append({
		new DetectDistance(threTravelDistance = 1200),
		new Trace(lineEdge = Right, Kp = 1.3, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 55 - SPEED_DELTA_MINUS, speedMax = 55 + SPEED_DELTA_PLUS) });

	// #2
	// 検知：距離（小円上、走行体が安定するまで）
	// 走行：右ライントレース
	scenario.append({
		new DetectDistance(threTravelDistance = 600),
		new Trace(lineEdge = Right, Kp = 1.3, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 55 - SPEED_DELTA_MINUS, speedMax = 55 + 0) });

	// #3
	// 検知：交差部
	// 走行：旋回量を制限した右ライントレース
	scenario.append({
		new DetectCrossing(),
		new Trace(lineEdge = Right, Kp = 1.3, Kd = 0.15, steeringMin = -30, steeringMax = 90, speedMin = 55 - SPEED_DELTA_MINUS, speedMax = 55 + 0) });
	
	// #4
	// 検知：交差部から0.3m進んだ
	// 走行：右ライントレース
	scenario.append({
		new DetectDistance(threTravelDistance = 300),
		new Trace(lineEdge = Right, Kp = 1.30, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 55 - SPEED_DELTA_MINUS, speedMax = 55 + SPEED_DELTA_PLUS) });
	
	// #5 (4-1)
	// 検知：黒ラインの内側に入った
	// 走行：旋回
	scenario.append({
		new DetectBrightness(brihgtnessMin = 0, brightnessMax = darkThreshold),
		new Turn(fixedTurningAmount = 20, speedMin = 55 - SPEED_DELTA_MINUS, speedMax = 55 + SPEED_DELTA_PLUS) });

	// #6 (4-2)
	// 検知：ラインエッジを検知
	// 走行：旋回
	scenario.append({
		new DetectBrightness(brihgtnessMin = grayThreshold, brightnessMax = 255),
		new Turn(fixedTurningAmount = -30, speedMin = 55 - SPEED_DELTA_MINUS, speedMax = 55 + SPEED_DELTA_PLUS) });

	// #7 (5)
	// 検知：5 1回目ラインエッジ切替から0.3m進んだ
	// 走行：左ライントレース
	scenario.append({
		new DetectDistance(threTravelDistance = 300),
		new Trace(lineEdge = Left, Kp = 1.30, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 55 - SPEED_DELTA_MINUS, speedMax = 55 + SPEED_DELTA_PLUS) });
	
	// #8
	// 検知：5 大円を高速で1.5m進んだ（GATE2→GATE3あたり）
	// 走行：左ライントレース
	scenario.append({
		new DetectDistance(threTravelDistance = 1500),
		//new Trace(lineEdge = Left, Kp = 0.75, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 70 - SPEED_DELTA_MINUS, speedMax = 70, -12) });
		new Trace(lineEdge = Left, Kp = 0.30, Kd = 0.06, steeringMin = -90, steeringMax = 90, speedMin = 80 - SPEED_DELTA_MINUS, speedMax = 80 + 0, -12) });

	// #9
	// 検知：大円高速走行から0.3m進んだ
	// 走行：左ライントレース
	scenario.append({
		new DetectDistance(threTravelDistance = 300),
		new Trace(lineEdge = Left, Kp = 1.30, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 50 - SPEED_DELTA_MINUS, speedMax = 50 + SPEED_DELTA_PLUS) });

	// #10 (6)
	// 検知：交差部
	// 走行：旋回量を制限した左ライントレース
	scenario.append({
		new DetectCrossing(),
		new Trace(lineEdge = Left, Kp = 1.30, Kd = 0.15, steeringMin = -90, steeringMax = 30, speedMin = 55 - SPEED_DELTA_MINUS, speedMax = 55 + SPEED_DELTA_PLUS) });

	// #11 (7)
	// 検知：2回目の交差部から0.15m進んだ
	// 走行：左ライントレース
	scenario.append({
		new DetectDistance(threTravelDistance = 150),
		new Trace(lineEdge = Left, Kp = 1.30, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 55 - SPEED_DELTA_MINUS, speedMax = 55 + SPEED_DELTA_PLUS) });

	// #12 (8-1)
	// 検知：黒ラインの内側に入った
	// 走行：旋回
	scenario.append({
		new DetectBrightness(brihgtnessMin = 0, brightnessMax = darkThreshold),
		new Turn(fixedTurningAmount = -5, speedMin = 55 - SPEED_DELTA_MINUS, speedMax = 55 + 0) });

	// #13 (8-2) 
	// 検知：ラインエッジを検知
	// 走行：旋回
	scenario.append({
		new DetectBrightness(brihgtnessMin = grayThreshold, brightnessMax = 255),
		new Turn(fixedTurningAmount = 5, speedMin = 55 - SPEED_DELTA_MINUS, speedMax = 55 + 0) });

	if(SHORT_ON == 0)//ショートカットなし
	{
		// #14 (9)やばいカーブの手前まで
		// 検知：きょり検知
		// 走行：右ライントレース
		scenario.append({
			new DetectDistance(threTravelDistance = 350),
			new Trace(lineEdge = Right, Kp = 1.30, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 50 - SPEED_DELTA_MINUS, speedMax = 50 + 0) });


		// #15（やばいカーブ部分をゆっくり）
		// 検知：距離
		// 走行：右ライントレース
		scenario.append({
			new DetectDistance(threTravelDistance = 200),
			new Trace(lineEdge = Right, Kp = 2.40, Kd = 0.20, steeringMin = -90, steeringMax = 90, speedMin = 50 - SPEED_DELTA_MINUS, speedMax = 50 + 0) });

		// #16（やばいカーブ後から、その後のかーぶ手前まで）
		// 検知：きょり検知
		// 走行：右ライントレース
		scenario.append({
			new DetectDistance(threTravelDistance = 350),
			new Trace(lineEdge = Right, Kp = 1.20, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 60 - SPEED_DELTA_MINUS, speedMax = 60 + 0) });

		// #17 (カーブ部分、長い直線の手前まで）
		// 検知：きょり検知
		// 走行：右ライントレース
		scenario.append({
			new DetectDistance(threTravelDistance = 900),
			new Trace(lineEdge = Right, Kp = 1.30, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 55 - SPEED_DELTA_MINUS, speedMax = 55 + 0) });

		// #18（1番長い直線が終わるまで）
		// 検知：きょり検知
		// 走行：右ライントレース
		scenario.append({
			new DetectDistance(threTravelDistance = 1200),
			new Trace(lineEdge = Right, Kp = 0.20, Kd = 0.05, steeringMin = -90, steeringMax = 90, speedMin = 90 - SPEED_DELTA_MINUS, speedMax = 90 + 0) });

		// #19（カーブ部分、最後の直線の手前まで）
		// 検知：きょり検知
		// 走行：右ライントレース
		scenario.append({
			new DetectDistance(threTravelDistance = 100),
			new Trace(lineEdge = Right, Kp = 1.3, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 50 - SPEED_DELTA_MINUS, speedMax = 50 + SPEED_DELTA_PLUS) });

		// #20（カーブ部分、最後の直線の手前まで）
		// 検知：きょり検知
		// 走行：右ライントレース
		scenario.append({
			new DetectDistance(threTravelDistance = 500),
			new Trace(lineEdge = Right, Kp = 2.4, Kd = 0.20, steeringMin = -90, steeringMax = 90, speedMin = 50 - SPEED_DELTA_MINUS, speedMax = 50 + SPEED_DELTA_PLUS) });

		// #21（最後の直線部分）
		// 検知：きょり検知
		// 走行：右ライントレース
		scenario.append({
			new DetectDistance(threTravelDistance = 600),
			//new Trace(lineEdge = Right, Kp = 1.20, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 60 - SPEED_DELTA_MINUS, speedMax = 60 + SPEED_DELTA_PLUS) });
			//new Trace(lineEdge = Right, Kp = 0.75, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 70 - SPEED_DELTA_MINUS, speedMax = 70) });
			new Trace(lineEdge = Right, Kp = 0.2, Kd = 0.05, steeringMin = -90, steeringMax = 90, speedMin = 90 - SPEED_DELTA_MINUS, speedMax = 90 + 0) });
	
	
		// #22
		// 検知：きょり検知
		// 走行：固定速度ライントレース
		scenario.append({
			new DetectDistance(threTravelDistance = 400),
			new Trace(lineEdge = Right, Kp = 1.30, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 50 - SPEED_DELTA_MINUS, speedMax = 50 + SPEED_DELTA_PLUS)});

		// #23
		// 検知：黒ラインの内側に入った
		// 走行：固定速度旋回
		scenario.append({
			new DetectBrightness(brihgtnessMin = 0, brightnessMax = darkThreshold),
			new Turn(fixedTurningAmount = 30, speedMin = 40 - SPEED_DELTA_MINUS, speedMax = 40 + SPEED_DELTA_PLUS) });

		// #24
		// 検知：黒ラインエッジを検知した
		// 走行：固定速度旋回
		scenario.append({
			new DetectBrightness(brihgtnessMin = 0, brightnessMax = darkThreshold),
			new Turn(fixedTurningAmount = 0, speedMin = 40 - SPEED_DELTA_MINUS, speedMax = 40 + SPEED_DELTA_PLUS) });

	
	}
	else if(SHORT_ON == 1)//ショートカットあり
	{
		// #14 (9)やばいカーブの手前まで
		// 検知：きょり検知
		// 走行：右ライントレース
		scenario.append({
			new DetectDistance(threTravelDistance = 200),
			new Trace(lineEdge = Right, Kp = 1.30, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 50 - SPEED_DELTA_MINUS, speedMax = 50 + 0) });

		// #15
		//検知：HSV検知(緑検知)
		//走行：ライントレース
		scenario.append({
			new DetectHsv(minH = GREEN_H_MIN, maxH = GREEN_H_MAX, minS = GREEN_S_MIN, maxS = GREEN_S_MAX, minV = GREEN_V_MIN, maxV= GREEN_V_MAX),
			new Turn(fixedTurningAmount = 0, speedMin = 90, speedMax = 90) });
		
		// #16
		//検知：白検知(213, 19, 171)
		//走行：固定速度ライントレース
		scenario.append({
			new DetectHsv(minH = WHITE_H_MIN, maxH = WHITE_H_MAX, minS = WHITE_S_MIN, maxS = WHITE_S_MAX, minV = WHITE_V_MIN, maxV= WHITE_V_MAX),
			new Turn(fixedTurningAmount = -20, speedMin = 65, speedMax = 65) });

		// #17
		//検知：黒内検知
		//走行：固定速度ライントレース
		scenario.append({
			new DetectBrightness(brihgtnessMin = 0, brightnessMax = grayThreshold),
			new Turn(fixedTurningAmount = -20, speedMin = 50, speedMax = 50) });

		// #18
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(10),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });

		// #19
		// 検知：交差部検知
		// 走行：超信地旋回
		scenario.append({
			new DetectCrossing(),
			new Turn(fixedTurningAmount = -60, speedMin = 0, speedMax = 0) });

		// #20
		// 検知：きょり検知
		// 走行：右ライントレース
		scenario.append({
			new DetectDistance(threTravelDistance = 300),
			new Trace(lineEdge = Right, Kp = 1.3, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 55 - SPEED_DELTA_MINUS, speedMax = 55) });
			
		// #21
		// 検知：距離検知
		// 走行：緩やか旋回
		scenario.append({
			new DetectDistance(threTravelDistance = 200),
			new Turn(fixedTurningAmount = 16, speedMin = 80, speedMax = 80) });

		// #22
		// 検知：距離検知
		// 走行：直進
		scenario.append({
			new DetectDistance(threTravelDistance = 800),
			new Turn(fixedTurningAmount = 0, speedMin = 90, speedMax = 90) });

		// #23
		// 検知：緑HSV検知
		// 走行：直進
		scenario.append({
			new DetectHsv(minH = GREEN_H_MIN, maxH = GREEN_H_MAX, minS = GREEN_S_MIN, maxS = GREEN_S_MAX, minV = GREEN_V_MIN, maxV= GREEN_V_MAX),
			new Turn(fixedTurningAmount = 0, speedMin = 90, speedMax = 90) });
		
		// #24
		// 検知：白HSV検知
		// 走行：ゆるやか旋回
		scenario.append({
			new DetectHsv(minH = WHITE_H_MIN, maxH = WHITE_H_MAX, minS = WHITE_S_MIN, maxS = WHITE_S_MAX, minV = WHITE_V_MIN, maxV= WHITE_V_MAX),
			new Turn(fixedTurningAmount = 20, speedMin = 70, speedMax = 70) });
		
		// #25
		// 検知：黒内検知
		// 走行：直進
		scenario.append({
			new DetectBrightness(brihgtnessMin = 0, brightnessMax = grayThreshold),
			new Turn(fixedTurningAmount = 5, speedMin = 50, speedMax = 50) });

		// #26
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(10),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });

		// #27
		// 検知：交差部検知
		// 走行：超信地旋回
		scenario.append({
			new DetectCrossing(),
			new Turn(fixedTurningAmount = 60, speedMin = 0, speedMax = 0) });

		// #28
		// 検知：HSV検知(青)
		// 走行：右ライントレース
		scenario.append({
			new DetectHsv(minH = BLUE_EDGE_H_MIN, maxH = BLUE_EDGE_H_MAX, minS = BLUE_EDGE_S_MIN, maxS = BLUE_EDGE_S_MAX, minV = BLUE_EDGE_V_MIN, maxV = BLUE_EDGE_V_MAX),
			new Trace(lineEdge = Left, Kp = 1.2, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 60 - SPEED_DELTA_MINUS, speedMax = 60) });
		
		// #29
		// 検知：きょり検知
		// 走行：右ライントレース
		scenario.append({
			new DetectDistance(threTravelDistance = 400),
			new Trace(lineEdge = Left, Kp = 1.2, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 60 - SPEED_DELTA_MINUS, speedMax = 60) });

	}

	
	
	
}




//*****************************************************************************************
//スラロームのシナリオを作成する
//シミュレータ初期位置：24.3 0 10 0
static void createScenario_slalom(Scenario& scenario)
{
	int whiteSla=WOOD_WHITE_R; int blackSla=WOOD_BLACK_R;
	const int   darkThreshold = gBlack + 20;
	const int   grayThreshold = (gWhite + gBlack) / 2 - 10;
	double      Kp,                 Kd;
	int    	    speedMin,           speedMax;
	int         steeringMin,        steeringMax;
	int         brihgtnessMin,      brightnessMax;
	int         fixedTurningAmount;
	double      minAngle,           maxAngle;
	int         minH, maxH, minS, maxS, minV, maxV;
	double      threTravelDistance;
	LeftOrRight lineEdge;
	int         distanceMax,        countMax;

	// #0 スタート
	// 検知：スタート操作検知
	// 走行：停止
	// scenario.append({
	// 	new DetectStart(),
	// 	new Stay() });

	// #1
	// 検知：HSV検知
	// 走行：ライントレース
	scenario.append({
		new DetectHsv(minH = BLUE_EDGE_H_MIN, maxH = BLUE_EDGE_H_MAX, minS = BLUE_EDGE_S_MIN, maxS = BLUE_EDGE_S_MAX, minV = BLUE_EDGE_V_MIN, maxV = BLUE_EDGE_V_MAX),
		new Trace(lineEdge = Left, Kp = 2.40, Kd = 0.20, steeringMin = -90, steeringMax = 90, speedMin = 45 - SPEED_DELTA_MINUS, speedMax = 45 + SPEED_DELTA_PLUS)});

	// #2
	// 検知：距離検知（スラロームの入口）
	// 走行：ライントレース
	scenario.append({
		new DetectDistance(threTravelDistance = 430),
		new Trace(lineEdge = Left, Kp = 1.30, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 45 - SPEED_DELTA_MINUS, speedMax = 45 + SPEED_DELTA_PLUS)});

	// #3****前後して方向をリセット*****
	// 検知：距離検知（PET1の直前)
	// 走行：ライントレース
	scenario.append({
		new DetectDistance(threTravelDistance = 175),
		new Trace(lineEdge = Left, Kp = 0.90, Kd = 0.12, steeringMin = -90, steeringMax = 90, speedMin = 45 - SPEED_DELTA_MINUS, speedMax = 45 + SPEED_DELTA_PLUS)});
	// #3
	// 検知：カウント検知
	// 走行：停止
	scenario.append({
		new DetectCount(50),
		new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });
	//#3
	// 検知：距離検知
	// 走行：後進
	scenario.append({
		new DetectDistance(threTravelDistance = 70),
		new Turn(fixedTurningAmount = 0, speedMin = -35, speedMax = -35) });
	// #3
	// 検知：カウント検知
	// 走行：停止
	scenario.append({
		new DetectCount(50),
		new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });
	// #3
	// 検知：距離検知（PET1の直前)
	// 走行：固定速度ライントレース
	scenario.append({
		new DetectDistance(threTravelDistance = 70),
		new Trace(lineEdge = Left, Kp = 0.90, Kd = 0.12, steeringMin = -90, steeringMax = 90, speedMin = 40 - SPEED_DELTA_MINUS, speedMax = 40)});
	// #3
	// 検知：カウント検知
	// 走行：停止
	scenario.append({
		new DetectCount(50),
		new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });
	//#3
	// 検知：距離検知
	// 走行：後進
	scenario.append({
		new DetectDistance(threTravelDistance = 40),
		new Turn(fixedTurningAmount = 0, speedMin = -35, speedMax = -35) });
	// #3
	// 検知：カウント検知
	// 走行：停止
	scenario.append({
		new DetectCount(50),
		new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });



	// #4*****PET1本目のを急旋回で横切る******
	// 検知：モータ角度検知
	// 走行：左へ急旋回
	scenario.append({
		new DetectMotorAngle(minAngle = 120, maxAngle = 10*1000),
		new Turn(fixedTurningAmount = 100, speedMin = 27, speedMax = 27) });
	// #4
	// 検知：カウント検知
	// 走行：停止
	scenario.append({
		new DetectCount(50),
		new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });
	// #4
	// 検知：カウント検知
	// 走行：右へ急旋回
	scenario.append({
		new DetectMotorAngle(minAngle = 120, maxAngle = 10*1000),
		new Turn(fixedTurningAmount = -100, speedMin = 27, speedMax = 27) });
	// #4
	// 検知：カウント検知
	// 走行：停止
	scenario.append({
		new DetectCount(50),
		new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });




	// #5***********(PET1本目目の前で距離をリセット)*************
	// 検知：距離orソナー検知
	// 走行：直進
	scenario.append({
		//new DetectDistance(threTravelDistance = 140),		
		new DetectSonarOrDistance(distanceMax = 10, countMax = 2, threTravelDistance = 140),
		new Turn(fixedTurningAmount = 0, speedMin = 35, speedMax = 35) });
	// #5
	// 検知：カウント検知
	// 走行：停止
	scenario.append({
		new DetectCount(50),
		new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });
	//#5
	// 検知：距離検知
	// 走行：後進
	scenario.append({
		new DetectDistance(threTravelDistance = 45),
		new Turn(fixedTurningAmount = 0, speedMin = -35, speedMax = -35) });
	// #5
	// 検知：カウント検知
	// 走行：停止
	scenario.append({
		new DetectCount(50),
		new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });




	// #6******(PET２を横切る→黒線こえるところまで)*********
	// 検知：モータ角度検知
	// 走行：右へ急旋回
	scenario.append({
		new DetectMotorAngle(minAngle = 80, maxAngle = 10*1000),
		new Turn(fixedTurningAmount = -100, speedMin = 27, speedMax = 27) });
	// #6
	// 検知：カウント検知
	// 走行：停止
	scenario.append({
		new DetectCount(50),
		new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });
	// #6
	// 検知：黒内検知
	// 走行：直進
	scenario.append({
		new DetectBrightness(brihgtnessMin = 0, brightnessMax = grayThreshold),
		new Turn(fixedTurningAmount = 0, speedMin = 35, speedMax = 35) });
	// #6
	// 検知：距離検知
	// 走行：直進
	scenario.append({
		new DetectDistance(threTravelDistance = 30),
		new Turn(fixedTurningAmount = 0, speedMin = 35, speedMax = 35) });
	// #6
	// 検知：カウント検知
	// 走行：停止
	scenario.append({
		new DetectCount(50),
		new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });
	



	// #7*********(PET3の目の前)************
	// 検知：距離検知
	// 走行：左へ緩やか旋回
	scenario.append({
		new DetectDistance(threTravelDistance = 115),
		new Turn(fixedTurningAmount = 25, speedMin = 40, speedMax = 40) });
	// #7
	// 検知：カウント検知
	// 走行：停止
	scenario.append({
		new DetectCount(50),
		new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });



	// #8********(PET3の目の前→横切る)***********
	// 検知：モータ角度検知
	// 走行：超信地旋回
	scenario.append({
		new DetectMotorAngle(minAngle = 100, maxAngle = 10*1000),
		new Turn(fixedTurningAmount = 45, speedMin = 0, speedMax = 0) });
	// #8
	// 検知：カウント検知
	// 走行：停止
	scenario.append({
		new DetectCount(50),
		new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });
	// #8
	// 検知：黒内検知
	// 走行：直進
	scenario.append({
		new DetectBrightness(brihgtnessMin = 0, brightnessMax = grayThreshold),
		new Turn(fixedTurningAmount = 0, speedMin = 35, speedMax = 35) });
	// #8
	// 検知：距離検知
	// 走行：直進
	scenario.append({
		new DetectDistance(threTravelDistance = 30),
		new Turn(fixedTurningAmount = 0, speedMin = 35, speedMax = 35) });
	// #8
	// 検知：カウント検知
	// 走行：停止
	scenario.append({
		new DetectCount(50),
		new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });




	// #9************(pet4本目の目の前)************
	// 検知：距離検知
	// 走行：右へ緩やか旋回
	scenario.append({
		new DetectDistance(threTravelDistance = 90),
		//new DetectSonarOrDistance(distanceMax = 14, countMax = 2, threTravelDistance = 100),
		new Turn(fixedTurningAmount = -25, speedMin = 40, speedMax = 40) });
	// #9
	// 検知：カウント検知
	// 走行：停止
	scenario.append({
		new DetectCount(50),
		new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });
	



	if(gSlaNo == SLA_NO1)//スラロームパターン1
	{
		// #10
		// 検知：モータ角度検知
		// 走行：超信地旋回
		scenario.append({
			new DetectMotorAngle(minAngle = 100, maxAngle = 10*1000),
			new Turn(fixedTurningAmount = -45, speedMin = 0, speedMax = 0) });
		// #10
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });
		


		// #11***(PET3,4本目の間、前後して黒線検知)**********
		// 検知：交差部検知
		// 走行：直進
		scenario.append({
			new DetectCrossing(),
			new Turn(fixedTurningAmount = 0, speedMin = 35, speedMax = 35) });
		// #11
		// 検知：距離検知
		// 走行：直進
		scenario.append({
			new DetectDistance(threTravelDistance = 50),
			new Turn(fixedTurningAmount = 0, speedMin = 35, speedMax = 35) });
		// #11
		// 検知：黒内検知
		// 走行：後退
		scenario.append({
			new DetectBrightness(brihgtnessMin = 0, brightnessMax = grayThreshold),
			new Turn(fixedTurningAmount = 0, speedMin = -35, speedMax = -35) });
		// #11
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });


		// #12**************旋回してﾗｲﾝﾄﾚｰｽ******************
		// 検知：距離検知
		// 走行：左へ強め旋回
		scenario.append({
			new DetectDistance(threTravelDistance = 20),
			new Turn(fixedTurningAmount = 45, speedMin = 35, speedMax = 35) });
		// #12
		// 検知：距離検知
		// 走行：左へ緩やか旋回
		scenario.append({
			new DetectDistance(threTravelDistance = 90),
			new Turn(fixedTurningAmount = 15, speedMin = 35, speedMax = 35) });
		// #12
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });

		// #13
		// 検知：ソナー検知
		// 走行：ライントレース
		scenario.append({
			new DetectSonar(distanceMax = 25, countMax = 2),
			new Trace(lineEdge = Right, Kp = 1.3, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 35, speedMax = 35) });
		// #13
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });
		//#13
		// 検知：距離検知
		// 走行：後退
		scenario.append({
			new DetectDistance(threTravelDistance = 80),
			new Turn(fixedTurningAmount = 0, speedMin = -35, speedMax = -35) });
		// #13
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });
		// #13
		// 検知：ソナー検知
		// 走行：ライントレース
		scenario.append({
			new DetectSonar(distanceMax = 25, countMax = 2),
			new Trace(lineEdge = Right, Kp = 1.3, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 35, speedMax = 35) });
		// #13
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });



		// #14
		// 検知：距離検知（色取りに行く）
		// 走行：右へ緩やか旋回
		scenario.append({
			new DetectDistance(threTravelDistance = 95),
			new Turn(fixedTurningAmount = -50, speedMin = 35, speedMax = 35) });
		// #14
		// 検知：ガレージの色ゲット（1秒停止）
		// 走行：停止
		scenario.append({
			new DetectGarageColor(),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });
		// #14
		// 検知：距離検知
		// 走行：右へ緩やか後ろ旋回
		scenario.append({
			new DetectDistance(threTravelDistance = 80),
			new Turn(fixedTurningAmount = -45, speedMin = -35, speedMax = -35) });
		// #14
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });


		// #15****前後して角度と距離リセット*****
		// 検知：距離検知
		// 走行：後進
		scenario.append({
			new DetectDistance(threTravelDistance = 60),
			new Turn(fixedTurningAmount = 0, speedMin = -35, speedMax = -35) });
		// #15
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });
		// #15
		// 検知：ソナー検知
		// 走行：ライントレース
		scenario.append({
			new DetectSonar(distanceMax = 25, countMax = 2),
			new Trace(lineEdge = Right, Kp = 1.3, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 35, speedMax = 35) });
		// #15
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });
		// #15
		// 検知：距離検知
		// 走行：後進
		scenario.append({
			new DetectDistance(threTravelDistance = 70),
			new Turn(fixedTurningAmount = 0, speedMin = -35, speedMax = -35) });
		// #15
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });
		// #15
		// 検知：ソナー検知
		// 走行：ライントレース
		scenario.append({
			new DetectSonar(distanceMax = 25, countMax = 2),
			new Trace(lineEdge = Right, Kp = 1.3, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 35, speedMax = 35) });
		// #15
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });



		// #16**********超信地旋回********************
		// 検知：モータ角度検知
		// 走行：超信地旋回
		scenario.append({
			new DetectMotorAngle(minAngle = 205, maxAngle = 10*1000),
			new Turn(fixedTurningAmount = 45, speedMin = 0, speedMax = 0) });
		// #16
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });


		// #17**********PET4本目を横切り、5本目のよこで止まる************************
		// 検知：距離検知
		// 走行：直進
		scenario.append({
			new DetectDistance(threTravelDistance = 188),
			new Turn(fixedTurningAmount = 0, speedMin = 38, speedMax = 38) });
		// #17
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });



		// #18**************(PET5,6の間を通過)**************************
		// 検知：距離検知
		// 走行：右へ緩やか旋回
		scenario.append({
			new DetectDistance(threTravelDistance = 80),
			new Turn(fixedTurningAmount = -30, speedMin = 35, speedMax = 35) });
		// #18
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });



		// #19******ライン復帰へ********
		// 検知：交差部検知
		// 走行：直進
		scenario.append({
			new DetectCrossing(),
			new Turn(fixedTurningAmount = 0, speedMin = 35, speedMax = 35) });
		// #19
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });

		// #19
		// 検知：距離検知
		// 走行：左へ緩やか旋回
		scenario.append({
			new DetectDistance(threTravelDistance = 80),
			new Turn(fixedTurningAmount = 38, speedMin = 35, speedMax = 35) });
		// #19
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });
		

		// #20
		// 検知：HSV検知(青)
		// 走行：ライントレース
		scenario.append({
			new DetectHsv(minH = BLUE_EDGE_H_MIN, maxH = BLUE_EDGE_H_MAX, minS = BLUE_EDGE_S_MIN, maxS = BLUE_EDGE_S_MAX, minV = BLUE_EDGE_V_MIN, maxV= BLUE_EDGE_V_MAX),
			new Trace(lineEdge = Right, Kp = 1.3, Kd = 0.15, steeringMin = -90, steeringMax = 90, speedMin = 45 - SPEED_DELTA_MINUS, speedMax = 45 + SPEED_DELTA_PLUS) });
	}
	else if(gSlaNo == SLA_NO2)//スラロームパターン2
	{
		// #10(PET３を倒す)
		// 検知：モータ角度検知
		// 走行：超信地旋回
		scenario.append({
			new DetectMotorAngle(minAngle = 40, maxAngle = 10*1000),
			new Turn(fixedTurningAmount = 45, speedMin = 0, speedMax = 0) });
		// #10
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });
		
		// #11(PET３を倒す)	
		// 検知：交差部検知
		// 走行：緩やか後進
		scenario.append({
			new DetectCrossing(),
			new Turn(fixedTurningAmount = 10, speedMin = -35, speedMax = -35) });
		



		// #12***********前後して角度をリセット***************
		// 検知：距離検知
		// 走行：右ライントレース
		scenario.append({
			new DetectDistance(threTravelDistance = 250),
			new Trace(lineEdge = Right, Kp = 2.4, Kd = 0.20, steeringMin = -90, steeringMax = 90, speedMin = 40 - SPEED_DELTA_MINUS, speedMax = 40) });
		// #12
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });
		// #12
		// 検知：距離検知
		// 走行：後進
		scenario.append({
			new DetectDistance(threTravelDistance = 150),
			new Turn(fixedTurningAmount = 0, speedMin = -35, speedMax = -35) });
		// #12
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });
		// #12
		// 検知：距離検知
		// 走行：右ライントレース
		scenario.append({
			new DetectDistance(threTravelDistance = 100),
			new Trace(lineEdge = Right, Kp = 2.4, Kd = 0.20, steeringMin = -90, steeringMax = 90, speedMin = 40 - SPEED_DELTA_MINUS, speedMax = 40) });
		// #12
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });




		// #13***************急旋回からの急旋回****************
		// 検知：モータ角検知
		// 走行：右へ急旋回
		scenario.append({
			new DetectMotorAngle(minAngle = 125, maxAngle = 10*1000),
			new Turn(fixedTurningAmount = -100, speedMin = 27, speedMax = 27) });
		// #13
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });
		// #13
		// 検知：カウント検知
		// 走行：左へ急旋回
		scenario.append({
			new DetectMotorAngle(minAngle = 125, maxAngle = 10*1000),
			new Turn(fixedTurningAmount = 100, speedMin = 27, speedMax = 27) });		
		// #13
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });


		// #14********(ガレージ色取りに行く)****************
		// 検知：ソナー検知
		// 走行：直進
		scenario.append({
			new DetectSonar(distanceMax = 15, countMax = 2),
			new Turn(fixedTurningAmount = 0, speedMin = 35, speedMax = 35) });
		// #14
		// 検知：ガレージの色ゲット（1秒停止）
		// 走行：停止
		scenario.append({
			new DetectGarageColor(),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });
		
		
		// #15********(少し下がる)***********
		// 検知：距離検知
		// 走行：後進
		scenario.append({
			new DetectDistance(threTravelDistance = 40),
			new Turn(fixedTurningAmount = 0, speedMin = -35, speedMax = -35) });
		// #15
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });


		// #16********(方向変換)*********
		// 検知：モータ角度検知
		// 走行：左へ急旋回
		scenario.append({
			new DetectMotorAngle(minAngle = 200, maxAngle = 10*1000),
			new Turn(fixedTurningAmount = 100, speedMin = 27, speedMax = 27) });
		// #16
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });



		// #17*********(PET6の目の前で止まる)************
		// 検知：距離検知
		// 走行：直進
		scenario.append({
			new DetectDistance(threTravelDistance = 90),
			new Turn(fixedTurningAmount = 0, speedMin = 35, speedMax = 35) });
		// #17
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });



		// #18*******(PETたちを横切る)**********
		// 検知：モータ角検知
		// 走行：左へ急旋回*************ここOK?*************************************************
		scenario.append({
			new DetectMotorAngle(minAngle = 100, maxAngle = 10*1000),
			new Turn(fixedTurningAmount = 100, speedMin = 27, speedMax = 27) });
		// #18
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });



		// #19*********(PET5,6の間を直進)******************
		// 検知：距離検知
		// 走行：直進
		scenario.append({
			new DetectDistance(threTravelDistance = 200),
			new Turn(fixedTurningAmount = 0, speedMin = 35, speedMax = 35) });
		// #19
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });


		// #20******(スラローム通過+ゆる→急旋回)**************
		// 検知：距離検知
		// 走行：緩やか旋回
		scenario.append({
			new DetectDistance(threTravelDistance = 50),
			new Turn(fixedTurningAmount = -20, speedMin = 40, speedMax = 40) });
		// #20
		// 検知：距離検知
		// 走行：急な旋回
		scenario.append({
			new DetectDistance(threTravelDistance = 100),
			new Turn(fixedTurningAmount = -60, speedMin = 40, speedMax = 40) });
		
		
		// #21************(ラインに復帰)*****************
		// 検知：交差部検知
		// 走行：直進
		scenario.append({
			new DetectCrossing(),
			new Turn(fixedTurningAmount = 0, speedMin = 35, speedMax = 35) });
		// #21
		// 検知：黒内側検知
		// 走行：左へ急旋回
		scenario.append({
			new DetectBrightness(brihgtnessMin = 0, brightnessMax = darkThreshold),
			new Turn(fixedTurningAmount =100, speedMin = 35, speedMax = 35) });


		// #22
		// 検知：HSV検知(青)
		// 走行：ライントレース
		scenario.append({
			new DetectHsv(minH = BLUE_EDGE_H_MIN, maxH = BLUE_EDGE_H_MAX, minS = BLUE_EDGE_S_MIN, maxS = BLUE_EDGE_S_MAX, minV = BLUE_EDGE_V_MIN, maxV= BLUE_EDGE_V_MAX),
			new Trace(lineEdge = Right, Kp = 2.4, Kd = 0.20, steeringMin = -90, steeringMax = 90, speedMin = 45 - SPEED_DELTA_MINUS, speedMax = 45) });


	}

	
}







//*****************************************************************************************
// ガレージのシナリオを作成する
	/*ガレージの色
	赤　H:0 S:214 V:94
	黄　H:52 S:235 V:104
	緑　H:143 S:239 V:65
	青　H:225 S:144 V:127
	初期位置
	2.2, 0, 9, 180
	回転方向
	反時計回りが正[rad]
	*/

static void createScenario_garage(Scenario& scenario)
{
	const int   darkThreshold = gBlack + 20;
	const int   grayThreshold = (gWhite + gBlack) / 2 - 10;
	double      Kp,                 Kd;
	int    	    speedMin,           speedMax;
	int         steeringMin,        steeringMax;
	int         brihgtnessMin,      brightnessMax;
	int         fixedTurningAmount;
	int         minH, maxH, minS, maxS, minV, maxV;
	double      threTravelDistance;
	LeftOrRight lineEdge;
	double      minAngle,           maxAngle;
	int         speed;

	// #0 スタート
	// 検知：スタート操作検知
	// 走行：停止
	// scenario.append({
	// 	new DetectStart(),
	// 	new Stay() });

	// #0(調整用)	
	// 検知：距離検知
	// 走行：右ライントレース
	// scenario.append({
	// 	new DetectDistance(threTravelDistance = 10),
	// 	new Trace(lineEdge = Left, Kp = 2.4, Kd = 0.20, steeringMin = -90, steeringMax = 90, speedMin = 45 - SPEED_DELTA_MINUS, speedMax = 45) });


	// #スラロームの最後******************************************************************************
	// 検知：HSV検知(青色検知)
	// 走行：固定速度ライントレース
	// scenario.append({
	// 	new DetectHsv(minH = BLUE_EDGE_H_MIN, maxH = BLUE_EDGE_H_MAX, minS = BLUE_EDGE_S_MIN, maxS = BLUE_EDGE_S_MAX, minV = BLUE_EDGE_V_MIN, maxV= BLUE_EDGE_V_MAX),
	// 	new Trace(lineEdge = Left, Kp = 2.4, Kd = 0.20, steeringMin = -90, steeringMax = 90, speedMin = 45 - SPEED_DELTA_MINUS, speedMax = 45 + SPEED_DELTA_PLUS) });

	// #1
	// 検知：カウント検知
	// 走行：停止
	scenario.append({
		new DetectCount(100),
		new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });

	// #2
	// 検知：モータ角度検知
	// 走行：走行：左後ろへゆるやか旋回
	scenario.append({
		new DetectMotorAngle(minAngle = 205, maxAngle = 10*1000),
		new Turn(fixedTurningAmount = 30, speedMin = -50, speedMax = -50) }); // 元々fixedTurningAmount = 30　強い35

	// #3
	// 検知：カウント検知
	// 走行：停止
	scenario.append({
		new DetectCount(50),
		new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });

	// #4
	// 検知：HSV検知:黒検知
	// 走行：まっすぐ後進
	scenario.append({
		new DetectHsv(minH = 0, maxH = 255, minS = 0, maxS = 255, minV = 0, maxV = BLACK_V_MAX),
		new Turn(fixedTurningAmount = 0, speedMin = -40, speedMax = -40) });

	// #5
	// 検知：カウント検知
	// 走行：停止
	scenario.append({
		new DetectCount(50),
		new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });

	// #6
	// 検知：モータ角度検知(物つかむてまえ)
	// 走行：左前へ急旋回
	scenario.append({
		new DetectMotorAngle(minAngle = 110, maxAngle = 10*1000),
		new Turn(fixedTurningAmount = 100, speedMin = 30, speedMax = 30) });

	//7
	// 検知：距離検知
	// 走行：左ライントレース
	scenario.append({
		new DetectDistance(threTravelDistance = 140),
		new Trace(lineEdge = Left, Kp = 2.4, Kd = 0.20, steeringMin = -90, steeringMax = 90, speedMin = 45 - SPEED_DELTA_MINUS, speedMax = 45) });
	

	/*ガレージが赤のとき***************************************************************************/
	if(gGarageColor == GARAGE_RED)
	{
		// #8
		// 検知：距離検知
		// 走行：すこし速く直進（ものをつかむため）
		scenario.append({
			new DetectDistance(threTravelDistance = 50),
			new Turn(fixedTurningAmount = 0, speedMin = 65, speedMax = 65) });


		// #9
		// 検知：距離検知（ガレージ手前まで）
		// 走行：直進
		scenario.append({
			new DetectDistance(threTravelDistance = 380),
			new Turn(fixedTurningAmount = 0, speedMin = 45, speedMax = 45) });

		// #10
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(10),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });

		// #11
		// 検知：モータ角度検知
		// 走行：右へ急旋回
		scenario.append({
			new DetectMotorAngle(minAngle = 80, maxAngle = 10*1000), 
			new Turn(fixedTurningAmount = -100, speedMin = 40, speedMax = 40) });

		// #12
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(10),
			new Turn(fixedTurningAmount = 0, speedMin = 10, speedMax = 10) });

		// #13
		// 検知：HSV検知（緑)
		// 走行：直進
		scenario.append({
			new DetectHsv(minH = GREEN_H_MIN, maxH = GREEN_H_MAX, minS = GREEN_S_MIN, maxS = GREEN_S_MAX, minV = GREEN_V_MIN, maxV = GREEN_V_MAX),
			new Turn(fixedTurningAmount = 0, speedMin = 45, speedMax = 45) });

		// #14
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(10),
			new Turn(fixedTurningAmount = 0, speedMin = 10, speedMax = 10) });

		// #15
		// 検知：モータ角度検知
		// 走行：左へ急旋回
		scenario.append({
			new DetectMotorAngle(minAngle = 370, maxAngle = 10*1000), 
			new Turn(fixedTurningAmount = 100, speedMin = 40, speedMax = 40) });

		// #16
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(10),
			new Turn(fixedTurningAmount = 0, speedMin = 10, speedMax = 10) });

		// #17
		// 検知：HSV検知（赤）
		// 走行：固定速度旋回
		scenario.append({
			new DetectHsv(minH = RED_H_MIN, maxH = RED_H_MAX, minS = RED_S_MIN, maxS = RED_S_MAX, minV = RED_V_MIN, maxV = RED_V_MAX),
			new Turn(fixedTurningAmount = 0, speedMin = 45, speedMax = 45) });

	}
	
	/*ガレージが緑のとき***************************************************************************/
	if(gGarageColor == GARAGE_GREEN)
	{
		// #8
		// 検知：距離検知
		// 走行：すこし速く直進（ものをつかむため）
		scenario.append({
			new DetectDistance(threTravelDistance = 50),
			new Turn(fixedTurningAmount = 0, speedMin = 65, speedMax = 65) });

		// #9
		// 検知：距離検知
		// 走行：直進
		scenario.append({
			new DetectDistance(threTravelDistance = 250),
			new Turn(fixedTurningAmount = 0, speedMin = 45, speedMax = 45) });

		// #10
		// 検知：HSV検知(赤 hsv=351,197,120 rgb=121, 28, 41)
		// 走行：直進
		scenario.append({
			new DetectHsv(minH = RED_H_MIN, maxH = RED_H_MAX, minS = RED_S_MIN, maxS = RED_S_MAX, minV = RED_V_MIN, maxV = RED_V_MAX),
			new Turn(fixedTurningAmount = 0, speedMin = 45, speedMax = 45) });

		// #11
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(10),
			new Turn(fixedTurningAmount = 0, speedMin = 10, speedMax = 10) });

		// #12
		// 検知：モータ角度検知
		// 走行：超信地旋回（反時計周り）
		scenario.append({
			new DetectMotorAngle(minAngle = 150, maxAngle = 10*1000),
			new Turn(fixedTurningAmount = 55, speedMin = 0, speedMax = 0) });
		
		// #13
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(10),
			new Turn(fixedTurningAmount = 0, speedMin = 10, speedMax = 10) });

		// #14
		// 検知：モータ角度検知
		// 走行：右へ急旋回
		scenario.append({
			new DetectMotorAngle(minAngle = 310, maxAngle = 10*1000),
			new Turn(fixedTurningAmount = -100, speedMin = 40, speedMax = 40) });
				
		// #15
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(10),
			new Turn(fixedTurningAmount = 0, speedMin = 10, speedMax = 10) });

		// #16
		// 検知：HSV検知：緑(H:151 S:138 V:70)
		// 走行：直進
		scenario.append({
			new DetectHsv(minH = GREEN_H_MIN, maxH = GREEN_H_MAX, minS = GREEN_S_MIN, maxS = GREEN_S_MAX, minV = GREEN_V_MIN, maxV = GREEN_V_MAX),
			new Turn(fixedTurningAmount = 0, speedMin = 50, speedMax = 50) });
	}

	/*ガレージが黄 or 青のとき***************************************************************************/
	if(gGarageColor == GARAGE_YELLOW || gGarageColor == GARAGE_BLUE)
	{
		// #8
		// 検知：距離検知
		// 走行：直進
		scenario.append({
			new DetectDistance(threTravelDistance = 50),
			new Turn(fixedTurningAmount = 0, speedMin = 65, speedMax = 65) });

		// #9
		// 検知：モータ角度検知
		// 走行：右へ急旋回
		scenario.append({
			new DetectMotorAngle(minAngle = 160, maxAngle = 10*1000),
			new Turn(fixedTurningAmount = -100, speedMin = 40, speedMax = 40) });

		// #10
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });

		// #11
		// 検知：黒内側検知
		// 走行：直進
		scenario.append({
			new DetectBrightness(brihgtnessMin = 0, brightnessMax = darkThreshold),
			new Turn(fixedTurningAmount =0, speedMin = 45, speedMax = 45) });

		// #12
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });

		// #13
		// 検知：交差部検知
		// 走行：超信地旋回
		scenario.append({
			new DetectCrossing(),
			new Turn(fixedTurningAmount = 60, speedMin = 0, speedMax = 0) });


		// #14
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });

		// #15
		// 検知：HSV検知（青エッジ）
		// 走行：左ライントレース
		scenario.append({
			new DetectHsv(minH = BLUE_EDGE_H_MIN, maxH = BLUE_EDGE_H_MAX, minS = BLUE_EDGE_S_MIN, maxS = BLUE_EDGE_S_MAX, minV = BLUE_EDGE_V_MIN, maxV = BLUE_EDGE_V_MAX),
			new Trace(lineEdge = Left, Kp = 2.40, Kd = 0.20, steeringMin = -90, steeringMax = 90, speedMin = 50 - SPEED_DELTA_MINUS, speedMax = 50) });

		// #16
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(50),
			new Turn(fixedTurningAmount = 0, speedMin = 0, speedMax = 0) });

		// #17
		// 検知：距離検知
		// 走行：直進
		scenario.append({
			new DetectDistance(threTravelDistance = 250),
			new Turn(fixedTurningAmount = 0, speedMin = 50, speedMax = 50) });
		
		// #18
		// 検知：カウント検知
		// 走行：停止
		scenario.append({
			new DetectCount(5),
			new Turn(fixedTurningAmount = 0, speedMin = 10, speedMax = 10) });

		/*ガレージが黄のとき***************************************************************************/
		if(gGarageColor == GARAGE_YELLOW)
		{
			// #19
			// 検知：モータ角度検知
			// 走行：右へ急旋回
			scenario.append({
				new DetectMotorAngle(minAngle = 70, maxAngle = 10*1000),
				new Turn(fixedTurningAmount = -100, speedMin = 40, speedMax = 40) });
			
			// #20
			// 検知：カウント検知
			// 走行：停止
			scenario.append({
				new DetectCount(5),
				new Turn(fixedTurningAmount = 0, speedMin = 10, speedMax = 10) });

			// #21
			// 検知：HSV検知（青）
			// 走行：直進
			scenario.append({
				new DetectHsv(minH = BLUE_H_MIN, maxH = BLUE_H_MAX, minS = BLUE_S_MIN, maxS = BLUE_S_MAX, minV = BLUE_V_MIN, maxV = BLUE_V_MAX), //青検知
				new Turn(fixedTurningAmount = 0, speedMin = 45, speedMax = 45) });

			// #22
			// 検知：距離検知
			// 走行：直進
			scenario.append({
				new DetectDistance(threTravelDistance = 10),
				new Turn(fixedTurningAmount = 0, speedMin = 45, speedMax = 45) });
				
			// #23
			// 検知：カウント検知
			// 走行：停止
			scenario.append({
				new DetectCount(5),
				new Turn(fixedTurningAmount = 0, speedMin = 10, speedMax = 10) });

			// #24
			// 検知：モータ角度検知
			// 走行：左へ急旋回
			scenario.append({
				new DetectMotorAngle(minAngle = 280, maxAngle = 10*1000),
				new Turn(fixedTurningAmount = 100, speedMin = 40, speedMax = 40) });

			// #25
			// 検知：カウント検知
			// 走行：停止
			scenario.append({
				new DetectCount(5),
				new Turn(fixedTurningAmount = 0, speedMin = 10, speedMax = 10) });

			// #26
			// 検知：色検知：黄(41 112 162)
			// 走行：固定速度旋回
			scenario.append({
				new DetectHsv(minH = YELLOW_H_MIN, maxH = YELLOW_H_MAX, minS = YELLOW_S_MIN, maxS = YELLOW_S_MAX, minV = YELLOW_V_MIN, maxV = YELLOW_V_MAX), //黄検知
				new Turn(fixedTurningAmount = 0, speedMin = 50, speedMax = 50) });
		
		
		}
		/*ガレージが青のとき***************************************************************************/
		if(gGarageColor == GARAGE_BLUE)
		{
			// #19
			// 検知：モータ角度検知
			// 走行：左へ急旋回
			scenario.append({
				new DetectMotorAngle(minAngle = 70, maxAngle = 10*1000),
				new Turn(fixedTurningAmount = 100, speedMin = 40, speedMax = 40) });

			// #20
			// 検知：カウント検知
			// 走行：停止
			scenario.append({
				new DetectCount(5),
				new Turn(fixedTurningAmount = 0, speedMin = 10, speedMax = 10) });

			// #21
			// 検知：色検知：黄(41 112 162)
			// 走行：固定速度旋回
			scenario.append({
				new DetectHsv(minH = YELLOW_H_MIN, maxH = YELLOW_H_MAX, minS = YELLOW_S_MIN, maxS = YELLOW_S_MAX, minV = YELLOW_V_MIN, maxV = YELLOW_V_MAX), //黄検知
				new Turn(fixedTurningAmount = 0, speedMin = 50, speedMax = 50) });
			
			// #22
			// 検知：カウント検知
			// 走行：停止
			scenario.append({
				new DetectCount(5),
				new Turn(fixedTurningAmount = 0, speedMin = 10, speedMax = 10) });

			// #23
			// 検知：モータ角度検知
			// 走行：右へ急旋回
			scenario.append({
				new DetectMotorAngle(minAngle = 300, maxAngle = 10*1000),
				new Turn(fixedTurningAmount = -100, speedMin = 40, speedMax = 40) });

			// #24
			// 検知：カウント検知
			// 走行：停止
			scenario.append({
				new DetectCount(5),
				new Turn(fixedTurningAmount = 0, speedMin = 10, speedMax = 10) });

			// #25
			// 検知：色検知：青
			// 走行：直進
			scenario.append({
				new DetectHsv(minH = BLUE_H_MIN, maxH = BLUE_H_MAX, minS = BLUE_S_MIN, maxS = BLUE_S_MAX, minV = BLUE_V_MIN, maxV = BLUE_V_MAX), //青検知
				new Turn(fixedTurningAmount = 0, speedMin = 50, speedMax = 50) });
		
		}
	}
}


static void calibration(int &black, int &white)
{
	ev3api::Motor arm(PORT_A);
	DetectStart detection1;
	DetectStart detection2;
	DetectStart detection3;
	int count;

	// 明るさを取得する関数（ラムダ式）
	auto getbr = [&]()
	{
		rgb_raw_t rgb;
		gRobot.colorSensor()->getRawColor(rgb);
		return (int)rgb.r;
	};

	// アームを上げて下げる関数（ラムダ式）
	auto movearm = [&]()
	{
		arm.setPWM(+20); for (int t = 0; t < 100; t++) { slp_tsk(); }
		arm.setPWM(-30); for (int t = 0; t < 100; t++) { slp_tsk(); }
		arm.setPWM(  0);
	};

	// 表示
	printf("手をかざしてください\n");
	// 検知するまで何もしない
	while (!detection1.detect()) { slp_tsk(); }
	// 表示
	printf("キャリブレーション 開始!\n");
	// アームを上げて下げる
	movearm();
	// 白を取得する
	printf("白を取得\n");
	count = 0;
	while (!detection2.detect())
	{
		white = getbr();
		// 0.5秒毎に明るさを表示
		if (++count == 50) { count = 0; printf("\r明るさ %3d", white); fflush(stdout); }
		slp_tsk();
	}
	// アームを上げて下げる
	movearm();
	// 黒を取得する
	printf("\n黒を取得\n");
	count = 0;
	while (!detection3.detect())
	{
		black = getbr();
		// 0.5秒毎に明るさを表示
		if (++count == 50) { count = 0; printf("\r明るさ %3d", black); fflush(stdout); }
		slp_tsk();
	}
	printf("\n黒 = %d, 白 = %d\n", black, white);
	// アームを上げて下げる
	movearm();
	// 表示
	printf("キャリブレーション 完了!\n");
}
